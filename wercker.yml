# docker box definition
box: java

# defining the dev pipeline
#
flywaymigrate:
  steps:
    - script:
          name: Migrate DB using Flyway
          code: |
             ./gradlew migrateDB -PdbUrl=jdbc:mysql://fgcart.cw8ksjytudj2.us-east-1.rds.amazonaws.com:3306/fgcart?useSSL=false&useUnicode=true&&characterEncoding=utf8
build:
  steps:
    - script:
        name: Build
        code: |
           ./gradlew --project-cache-dir=$WERCKER_CACHE_DIR build -x test

runtests:
   steps:
    - script:
        name: gradletest
        code: |
           ./gradlew --project-cache-dir=$WERCKER_CACHE_DIR build -PspringProfiles=aws

builddocker:
  steps:
    - script:
        name: make opt dir
        code: |
          mkdir $WERCKER_OUTPUT_DIR/opt
          echo "Made opt directory"
    - script:
        name: build docker
        code: |
          cp $WERCKER_SOURCE_DIR/build/libs/*.jar  $WERCKER_OUTPUT_DIR/opt/app.jar
          echo "Copied app.jar"
    - script:
        name: move docker start file
        code: |
          cp $WERCKER_SOURCE_DIR/start.sh  $WERCKER_OUTPUT_DIR/opt/start.sh
          echo "Copied start.sh"
    - script:
        name: remove build
        code: |
          rm -rfv $WERCKER_SOURCE_DIR/build
          echo "deleted build dir"
    - script:
        name: remove src
        code: |
          rm -vrf $WERCKER_SOURCE_DIR/src
          echo "Deleted src dir"
    - script:
        name: remove gradle
        code: |
          rm -vrf $WERCKER_SOURCE_DIR/gradle
          echo "Removed all gradle files"
deploy:
  steps:
    - internal/docker-scratch-push:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
        tag: latest
        repository: lightsidenemo/fg-cartservice
        ports: "3306,8080,5005,9004"
        entrypoint: "/opt/start.sh"
        stopsignal: SIGTERM

azure-push:
  steps:
    - script:
        code: |
          echo 'hi from alpine'
    - internal/docker-push:
        azure-client-id: '5d2d8717-fbf1-4a32-8c3e-bbfa181a6bb7'
        azure-client-secret: 'KU/OlOlSOwughOCDfVi6h7W902QYwqtSsqTofmeDCOA='
        azure-subscription-id: 'a26787be-9170-4e1d-ae68-872cddbb737a'
        azure-tenant-id: '1062da5f-d171-4785-99d6-bcc3895a3e86'
        azure-resource-group: 'fgnemo'
        azure-registry-name: 'fgnemo'
        azure-login-server: 'https://fgnemo.azurecr.io'
        repository: 'fgnemo'
        tag: ${WERCKER_GIT_COMMIT}
        cmd: "java -Djava.security.egd=file:/dev/./urandom -jar /app.jar  "

